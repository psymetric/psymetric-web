# API Hammer Script\n# Deterministic smoke testing for PsyMetric APIs\n# Usage:\n#   powershell -NoProfile -ExecutionPolicy Bypass -File .\\scripts\\api-hammer.ps1 -Base \"https://your-deployment.vercel.app\"\n#   powershell -NoProfile -ExecutionPolicy Bypass -File .\\scripts\\api-hammer.ps1 -Base \"http://localhost:3000\"\n\nparam(\n    [Parameter(Mandatory=$false)]\n    [string]$Base = \"http://localhost:3000\"\n)\n\n$ErrorActionPreference = \"Continue\"\n\n$PassCount = 0\n$FailCount = 0\n\n# Clean the base URL\n$Base = $Base.TrimEnd('/')\n\nWrite-Host (\"API Hammer - Testing \" + $Base) -ForegroundColor Cyan\nWrite-Host \"\"\n\nfunction Test-Endpoint {\n    param(\n        [string]$Method,\n        [string]$Url,\n        [int]$ExpectedStatus,\n        [string]$Description\n    )\n\n    try {\n        Write-Host (\"Testing: \" + $Description) -NoNewline\n\n        # Use more robust web request with timeout\n        $response = Invoke-WebRequest -Uri $Url -Method $Method -SkipHttpErrorCheck -TimeoutSec 30 -UseBasicParsing\n\n        if ($response.StatusCode -eq $ExpectedStatus) {\n            Write-Host \"  PASS\" -ForegroundColor Green\n            return $true\n        } else {\n            Write-Host (\"  FAIL (got \" + $response.StatusCode + \", expected \" + $ExpectedStatus + \")\") -ForegroundColor Red\n            return $false\n        }\n    }\n    catch {\n        Write-Host (\"  FAIL (exception: \" + $_.Exception.Message + \")\") -ForegroundColor Red\n        return $false\n    }\n}\n\n# Smoke Tests - Basic GET operations should work\nWrite-Host \"=== SMOKE TESTS (GET) ===\" -ForegroundColor Yellow\n\nif (Test-Endpoint \"GET\" \"$Base/api/events\" 200 \"GET /api/events\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/entities\" 200 \"GET /api/entities\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/relationships\" 200 \"GET /api/relationships\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/distribution-events\" 200 \"GET /api/distribution-events\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/metric-snapshots\" 200 \"GET /api/metric-snapshots\") { $PassCount++ } else { $FailCount++ }\n\nWrite-Host \"\"\nWrite-Host \"=== VALIDATION TESTS (400 expected) ===\" -ForegroundColor Yellow\n\n# Validation Tests - Bad inputs should return 400, not 500\nif (Test-Endpoint \"GET\" \"$Base/api/entities?entityType=invalid\" 400 \"Bad entityType filter\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/entities?status=invalid\" 400 \"Bad status filter\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/relationships?fromEntityId=not-a-uuid\" 400 \"Bad fromEntityId UUID\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/relationships?toEntityId=invalid-uuid-format\" 400 \"Bad toEntityId UUID\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/distribution-events?platform=invalid\" 400 \"Bad platform filter\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/metric-snapshots?metricType=invalid\" 400 \"Bad metricType filter\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/metric-snapshots?entityId=not-a-uuid\" 400 \"Bad entityId UUID\") { $PassCount++ } else { $FailCount++ }\n\nWrite-Host \"\"\nWrite-Host \"=== PAGINATION TESTS ===\" -ForegroundColor Yellow\n\n# Test pagination edge cases\nif (Test-Endpoint \"GET\" \"$Base/api/entities?page=1&limit=5\" 200 \"Basic pagination\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/entities?page=999&limit=20\" 200 \"High page number\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/entities?limit=1\" 200 \"Minimum limit\") { $PassCount++ } else { $FailCount++ }\nif (Test-Endpoint \"GET\" \"$Base/api/entities?limit=50\" 200 \"Maximum limit\") { $PassCount++ } else { $FailCount++ }\n\n# Summary\nWrite-Host \"\"\nWrite-Host \"=== SUMMARY ===\" -ForegroundColor Yellow\nWrite-Host (\"PASS: \" + $PassCount) -ForegroundColor Green\nWrite-Host (\"FAIL: \" + $FailCount) -ForegroundColor Red\n\nif ($FailCount -eq 0) {\n    Write-Host \"\"\n    Write-Host \"ALL TESTS PASSED\" -ForegroundColor Green\n    Write-Host \"System is stable and validates inputs properly.\" -ForegroundColor Gray\n    exit 0\n} else {\n    Write-Host \"\"\n    Write-Host \"SOME TESTS FAILED\" -ForegroundColor Red\n    Write-Host \"Check endpoint implementations and validation logic.\" -ForegroundColor Gray\n    exit 1\n}\n