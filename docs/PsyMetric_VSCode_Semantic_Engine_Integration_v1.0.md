# PsyMetric VS Code Semantic Engine Integration

## Operator Surface Architecture (Aligned Revision)

This document defines how the VS Code extension integrates with the PsyMetric backend and MCP server.

Status: Aligned with ROADMAP phase discipline, MCP authority rules, and BYDA-S apply contract.

------------------------------------------------------------------------

## Purpose

VS Code is the primary operator interface for:

- Reviewing entities
- Inspecting relationships
- Viewing project-scoped data
- Running audits (Phase 2+ only)
- Approving patch bundles (Phase 2+ only)
- Ingesting evidence (Phase 3+ only)
- Viewing token/cost status for audits (Phase 3+ only)

It replaces the need for a traditional web dashboard.

------------------------------------------------------------------------

## Architectural Principles

1. VS Code is a client only.
2. All canonical mutations flow through Backend API.
3. MCP server acts as transport adapter only.
4. No direct database access from extension.
5. Human approval required for all mutations.
6. projectId always visible in UI.
7. Extension never constructs patch objects.
8. Extension never invokes LLM broker directly.

------------------------------------------------------------------------

# Phase Discipline (Roadmap-Aligned)

## Phase 1 — Read-Only Only

Enabled panels:

- Project Context Panel (project selection + read-only status)
- Entity Explorer
- Entity Detail View (entity fields only)
- Relationship Graph Viewer

Allowed MCP tools:

- list_projects
- search_entities
- get_entity
- get_entity_graph

Explicitly disabled in Phase 1:

- Audit Runner
- Patch Review Panel
- Evidence Ingest Panel
- Any write tool
- Any LLM invocation
- Metric monitoring
- Event timeline view (unless delivered via existing read tool contract)

Phase 1 goal: prove MCP → Backend → Response loop with strict projectId scoping.

------------------------------------------------------------------------

## Phase 2 — Deterministic Audit (No LLM)

Enabled:

- Audit Runner (S0 only)
- Patch Review Panel
- Apply Approved button

Required MCP tools (Phase 2+):

- run_byda_s_audit (creates DraftArtifact; write-class)
- apply_approved_patches (write-class)

Constraints:

- Audit generated by backend deterministic logic only.
- Audit stored as DraftArtifact (existing enum) with `llmMeta.kind="byda_s_audit"`.
- Extension renders stored audit; it must not fabricate or store AuditReport JSON.

------------------------------------------------------------------------

## Phase 3 — LLM-Backed Audit

Enabled:

- LLM-assisted audit generation
- Checksum display
- Model snapshot display
- Prompt version display
- Cache hit indicator
- Stale audit indicator (checksum-based)
- Token/cost preview and remaining budget display

Still prohibited:

- Auto-apply
- Background audit loops
- Cross-project audits

------------------------------------------------------------------------

## Integration Flow

User Action → VS Code Extension → MCP Tool → Backend API → Database

All canonical mutations:

- Flow through Backend API
- Occur inside prisma.$transaction()
- Emit canonical EventLog entries

------------------------------------------------------------------------

## Panel to Tool Mapping (Hard Constraint)

The extension must not call tools outside these mappings.

| Panel | Allowed tools (Phase 1) | Additional tools (Phase 2+) | Additional tools (Phase 3+) |
|---|---|---|---|
| Project Context | list_projects | (optional) get_project_status (if added) | (optional) get_cost_status (if added) |
| Entity Explorer | search_entities | — | — |
| Entity Detail View | get_entity | — | — |
| Relationship Graph Viewer | get_entity_graph | — | — |
| Audit Runner | — | run_byda_s_audit | run_byda_s_audit |
| Patch Review Panel | — | apply_approved_patches | apply_approved_patches |
| Evidence Ingest Panel | — | — | ingest_evidence_csv |

If a tool does not exist in the MCP contract, the panel cannot call it.

------------------------------------------------------------------------

## Core Panels (Final Architecture)

### 1. Project Context Panel

Displays:

- Active projectId (required)
- Entity counts (if available via read tools)
- Recent EventLog entries (only if delivered via scoped read tool)
- Audit status (if exists)

Project context must be explicit and visible at all times.

On project change:

- Clear any loaded audit report state
- Disable Patch Review Panel until a new audit is selected/run for the active project

------------------------------------------------------------------------

### 2. Entity Explorer

Tree view of:

- Guides
- Concepts
- Projects
- News

Clicking entity loads details via MCP read tool.

No entity mutation allowed from this panel.

------------------------------------------------------------------------

### 3. Audit Runner (Phase 2+)

Button: "Run BYDA-S Audit"

Behavior:

- Calls MCP tool (which forwards to backend)
- Backend generates or retrieves audit
- Backend returns an `auditDraftId` for rendering

Audit panel displays:

- Prompt version
- Model snapshot identifier
- Checksum
- Audit timestamp
- Layer scores
- Gap list

Staleness rules:

- Phase 2: stale if entity version changed (e.g., updatedAt mismatch)
- Phase 3: stale if checksum no longer matches current input checksum computed by backend

UI must display backend-provided staleness status and reason.

Cache visibility (Phase 3+):

- Display "Cache Hit" or "Fresh Run" indicator based on backend response metadata

Cost visibility (Phase 3+):

- Display estimated token cost before running
- Display remaining project audit budget / quota (if backend exposes it)

------------------------------------------------------------------------

### 4. Patch Review Panel (Phase 2+)

Displays:

- Patch list from stored AuditReport
- Severity indicator
- Evidence references

Extension behavior:

- Checkbox per patch ID
- No editable patch fields
- No client-side patch construction
- No "select all" control in v1 (equivalent to apply-all)

Apply Approved button:

On click, calls write tool with:

- projectId
- auditDraftId
- approvedPatchIds[]

Extension must not send patch objects.
Extension must not reserialize or modify AuditReport content for submission.

UX safety:

- Disable Apply button while request is in-flight (debounce double-click)
- Re-enable only after response or failure

------------------------------------------------------------------------

### 5. Evidence Ingest Panel (Phase 3+)

CSV upload behavior:

- Extension may validate only: file extension and max size
- Backend performs full validation
- Backend returns row validation summary
- No silent partial failures

------------------------------------------------------------------------

## Safety Controls

- Apply button disabled until at least one patch selected
- Confirmation modal before invoking any write tool
- projectId always visible
- entityId visible before mutation
- BLOCKING severity highlighted
- No keyboard shortcut bypass for apply
- Clear/disable mutation panels on project switch

------------------------------------------------------------------------

## Error Handling

All errors must come from backend in structured format.

Extension must display:

- Project mismatch errors
- Validation errors
- Transaction rollback errors
- Rate limit errors
- Token budget exceeded errors (Phase 3+)

Retry policy:

- Read tools only: at most 1 automatic retry with bounded backoff
- No retries for write tools

------------------------------------------------------------------------

## Determinism Display Requirements (Phase 3+)

Audit panel must display:

- promptVersion
- modelVersion (snapshot, not alias)
- checksum
- auditedAt

The extension does not compute checksums locally. It displays backend-provided values.

------------------------------------------------------------------------

## Non-Goals

- No background audits
- No auto-apply
- No auto-publish
- No cross-project view
- No multi-user concurrency model
- No local caching that bypasses backend authority

------------------------------------------------------------------------

## Summary

The VS Code extension is a controlled operator cockpit.

It:

- Displays project-scoped state
- Requests audits from backend
- Presents structured proposals
- Sends only approved patch IDs

All canonical state changes remain backend-controlled and transactionally safe.
