# PsyMetric Audit & Fixes â€” February 13, 2026

**Auditor:** Claude Opus 4.6  
**Scope:** Full codebase review â€” schema, API routes, dashboard, public pages, config  
**Files read:** All 37 source files + config + docs  

---

## Work Log

### 1. Transaction wrapping for state-change + event-log pairs
**Priority:** ðŸ”´ Critical  
**Issue:** Multiple API endpoints perform entity state changes and event logging as separate operations. If the event log write fails, you get a state change with no audit trail â€” breaking the core event-sourced invariant.  
**Files modified:**
- `src/app/api/entities/[id]/route.ts` (PATCH)
- `src/app/api/entities/[id]/publish/route.ts`
- `src/app/api/entities/[id]/reject/route.ts`
- `src/app/api/entities/[id]/request-publish/route.ts`
- `src/app/api/source-items/capture/route.ts`
- `src/app/api/source-items/[id]/status/route.ts`
- `src/app/api/distribution-events/route.ts` (POST)
- `src/app/api/metric-snapshots/route.ts` (POST)
**Fix:** Wrapped all state-mutation + event-log operations in `prisma.$transaction()` blocks, matching the pattern already used in `api/relationships/route.ts`.

### 2. Await `searchParams` in server component list pages (Next.js 16 compat)
**Priority:** ðŸ”´ Critical  
**Issue:** Next.js 16 changed `searchParams` to a `Promise` (like `params`). List pages were reading it synchronously, which will break on deployment.  
**Files modified:**
- `src/app/dashboard/entities/page.tsx`
- `src/app/dashboard/distribution-events/page.tsx`
- `src/app/dashboard/metric-snapshots/page.tsx`
**Fix:** Changed function signatures to accept `searchParams: Promise<SearchParams>` and await before use.

### 3. Update dashboard navigation
**Priority:** ðŸ”´ Critical  
**Issue:** Dashboard nav still shows Entity Library and Publish Queue as greyed-out placeholders. Entities, Distribution Events, and Metric Snapshots dashboards all exist and are functional.  
**Files modified:**
- `src/app/dashboard/layout.tsx`
**Fix:** Replaced placeholder spans with working `<a>` links to all dashboard sections.

### 4. Add `GET /api/entities/[id]` endpoint
**Priority:** ðŸŸ¡ Moderate  
**Issue:** No API route to fetch a single entity by ID. Dashboard works around this with direct Prisma reads, but external consumers have no way to GET a single entity.  
**Files modified:**
- `src/app/api/entities/[id]/route.ts`
**Fix:** Added GET handler alongside existing PATCH handler with UUID validation and proper response shape.

### 5. Extract shared toast hook
**Priority:** ðŸŸ¡ Moderate  
**Issue:** Identical toast state management and rendering code duplicated across 5 client components (~40 lines each). Multiple components rendering fixed-position toasts overlay on each other.  
**Files created:**
- `src/lib/use-toast.ts`
- `src/app/dashboard/toast-container.tsx`
**Files modified:**
- `src/app/dashboard/entities/[id]/entity-editor.tsx`
- `src/app/dashboard/entities/[id]/lifecycle-actions.tsx`
- `src/app/dashboard/entities/[id]/relationships-panel.tsx`
- `src/app/dashboard/entities/[id]/relationship-creator.tsx`
**Fix:** Created `useToast` hook and `ToastContainer` component. Refactored 4 entity-detail components to use shared infrastructure. Source inbox left as-is (self-contained, complex sub-component interactions).

### 6. UUID validation on metric snapshot `entityId` filter
**Priority:** ðŸŸ¡ Moderate  
**Issue:** Originally flagged as missing; upon implementation, found it was already present in GET handler.  
**Status:** âœ… Already correct â€” no change needed.

### 7. Eliminate dead `logEvent` wrapper
**Priority:** ðŸŸ¢ Minor (cleanup)  
**Issue:** After transaction wrapping, no file imports `logEvent` from `src/lib/events.ts`. Also converted last holdout (`validate/route.ts`) to direct `prisma.eventLog.create()`.  
**Files modified:**
- `src/app/api/entities/[id]/validate/route.ts` â€” removed `logEvent` import, replaced with direct Prisma call
**Note:** `src/lib/events.ts` is now dead code. Retained as pattern documentation; safe to delete.

### 8. Atomic Promote endpoint
**Priority:** ðŸ”´ Critical (data integrity)  
**Issue:** PromoteModal in source-inbox made 3 sequential API calls (create entity â†’ create relationship â†’ update source status). If step 2 failed, orphaned entity. If step 3 failed, source status unchanged.  
**Files created:**
- `src/app/api/source-items/[id]/promote/route.ts`
**Files modified:**
- `src/app/dashboard/inbox/source-inbox.tsx` â€” PromoteModal now calls single `/api/source-items/[id]/promote`
**Fix:** New `POST /api/source-items/[id]/promote` does entity creation + relationship + source status + all 3 event logs in a single `$transaction`.

### 9. Entity POST transaction wrapping + response fix
**Priority:** ðŸ”´ Critical  
**Issue:** `POST /api/entities` still used `logEvent` wrapper. Also returned a partial response (omitting summary, difficulty, conceptKind, repoUrl).  
**Files modified:**
- `src/app/api/entities/route.ts`
**Fix:** Wrapped in `$transaction`, removed `logEvent` import, returns full entity object.

### 10. Add `difficulty` and `repoUrl` to PATCH allowlist
**Priority:** ðŸŸ¡ Moderate  
**Issue:** Entity editor couldn't update `difficulty` (useful for all types) or `repoUrl` (required for projects). Wrong values couldn't be fixed without direct DB access.  
**Files modified:**
- `src/app/api/entities/[id]/route.ts`
**Fix:** Added both fields to `ALLOWED_FIELDS` with proper validation (enum check for difficulty, URL validation for repoUrl).

### 11. Relax `canonicalUrl` validation
**Priority:** ðŸŸ¡ Moderate  
**Issue:** PATCH endpoint required `canonicalUrl` to start with `/`. External canonical URLs (`https://...`) were rejected.  
**Files modified:**
- `src/app/api/entities/[id]/route.ts`
**Fix:** Now accepts both paths (`/foo/bar`) and full URLs (`https://...`).

### 12. Fix entity list pagination ordering
**Priority:** ðŸŸ¡ Moderate  
**Issue:** Entity list API and dashboard page ordered by `updatedAt desc`. Editing an entity caused it to jump to page 1, making pagination unstable.  
**Files modified:**
- `src/app/api/entities/route.ts`
- `src/app/dashboard/entities/page.tsx`
**Fix:** Changed to `[createdAt desc, id desc]` â€” deterministic, matches pattern used by relationships/events/distribution/metrics.

### 13. Entity POST response includes all fields
**Priority:** ðŸŸ¢ Minor  
**Issue:** `POST /api/entities` returned only id, entityType, title, slug, status, createdAt. Omitted summary, difficulty, conceptKind, repoUrl.  
**Files modified:**
- `src/app/api/entities/route.ts`
**Fix:** Now returns full entity object.

---

## Summary of Changes

**Files modified:** 19  
**Files created:** 4  
**Net effect:**
- All state-mutating API endpoints now use `prisma.$transaction()` for atomic state+event writes (11 endpoints total)
- `logEvent` wrapper fully eliminated from all call sites (dead code in `events.ts`)
- All 3 dashboard list pages use `Promise<SearchParams>` for Next.js 16 compat
- Dashboard nav links to all 4 existing sections (was only linking to inbox)
- `GET /api/entities/[id]` added â€” CRUD contract complete
- Shared toast hook extracted to `src/lib/use-toast.ts` + `ToastContainer`
- Atomic promote endpoint replaces fragile 3-step client workflow
- PATCH allowlist expanded: `difficulty`, `repoUrl` now editable
- `canonicalUrl` accepts full URLs (not just paths)
- Entity list pagination deterministic (`createdAt desc, id desc`)
- Entity POST returns full object

---

## Findings Not Yet Addressed (Future Work)

- Public news pages have no styling
- Duplicate `StatusBadge` components across files (source-inbox has its own copy)
- Entity editor UI doesn't expose `difficulty` or `repoUrl` fields yet (API accepts them now)
