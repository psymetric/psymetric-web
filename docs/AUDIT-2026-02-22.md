# BYDA Unified Audit Report — 2026-02-22

**Profile:** Standard  
**Scope:** Platform (BYDA-P L0–L7)  
**Entity:** N/A (platform audit only)

---

## Summary

**Platform Readiness Score:** 79/100 (Yellow)  
**Content Quality Score:** N/A  
**Overall Health:** Yellow — attention needed

**Finding Breakdown:** 0 BLOCKING · 0 HIGH · 3 MEDIUM · 3 LOW

---

## Platform Findings (BYDA-P)

### BLOCKING

None.

### HIGH

None.

### MEDIUM

**M1 — EventLog writes outside `$transaction` on validation failure**  
— `src/app/api/entities/[id]/validate/route.ts` (line ~67)  
— `src/app/api/entities/[id]/request-publish/route.ts` (line ~73)  
— Invariant: §2.1 (no mutation outside transaction)  
**Context:** Both routes write an `ENTITY_VALIDATION_FAILED` EventLog entry via standalone `prisma.eventLog.create()` when validation fails. No entity state is mutated alongside it — these are observational log-only writes.  
**Assessment:** `POST /api/entities/[id]/validate` is a read-only validation check that logs failures but never mutates entity state. The standalone EventLog write is acceptable as a diagnostic observation, not a state transition. However, this is a documented exception — if a future change adds mutation to this path, it MUST be wrapped in `$transaction`. `POST /api/entities/[id]/request-publish` has two code paths: (a) validation failure → standalone EventLog write only (no entity mutation, same exception as validate), (b) validation pass → entity status mutation + EventLog inside `prisma.$transaction()` (correctly atomic). Both paths are currently correct but the exception should remain documented.

**M2 — Missing JSON body parse error handling (3 endpoints)**  
— `src/app/api/entities/route.ts` POST handler (line ~86)  
— `src/app/api/source-items/capture/route.ts` POST handler (line ~30)  
— `src/app/api/source-items/[id]/status/route.ts` PUT handler (line ~34)  
— Invariant: L7.3 (edge case handling)  
These endpoints call `await request.json()` without a try/catch. Malformed JSON bodies produce an unhandled throw caught by the outer catch, which returns `serverError()` (500) instead of `badRequest("Invalid JSON body")` (400). Other mutation endpoints (relationships, distribution-events, quotable-blocks, draft-artifacts, audits/run) correctly wrap this call. Align these three.

**M3 — `entity-validation.ts` relationship query lacks projectId scope** ✅ FIXED 2026-02-22  
— `src/lib/entity-validation.ts` (line ~72)  
— Invariant: §1.2 (all queries must scope by projectId)  
**Problem:** `validateEntityForPublish` queried `prisma.entityRelation.findFirst()` without `projectId` in the `where` clause. While the entity UUID practically constrains the result, the app-layer invariant requires explicit `projectId` scoping on every query — DB triggers are defense-in-depth, not a substitute.  
**Impact:** Cross-project read leakage risk. A relationship belonging to another project sharing the same entity UUID pattern could theoretically be returned.  
**Fix applied:** Added `projectId: string` to the function signature, threaded it from both callers (`validate/route.ts` and `request-publish/route.ts`), and added `projectId` to the Prisma `where` clause. No schema changes. No endpoint changes.

### LOW

**L1 — POST /api/relationships returns 200 instead of 201**  
— `src/app/api/relationships/route.ts` POST handler (line ~162)  
— Invariant: L2.4 (POST = create, returns 201)  
Uses `successResponse()` (200) instead of `createdResponse()` (201). All other creation POST endpoints correctly return 201.

**L2 — `docs/08-METRIC-TYPE-VOCABULARY.md` diverges from schema MetricType enum**  
— `docs/08-METRIC-TYPE-VOCABULARY.md` vs `prisma/schema.prisma` MetricType enum  
— Invariant: L3.2 (cross-document consistency)  
The vocabulary doc defines generic names (`views`, `impressions`, `clicks`, `likes`, `shares`) and states "Do not encode platform into the metricType." However, the actual schema enum uses platform-prefixed names (`x_impressions`, `gsc_clicks`, `yt_views`, `geo_citability_score`, etc.). The schema is the canonical source of truth but the doc contradicts it. Update the doc to reflect the implemented naming convention.

**L3 — Roadmap Phase 2 status label is stale**  
— `docs/ROADMAP.md` Phase 2 section header  
— Invariant: L3.1 (roadmap accuracy)  
Phase 2 is marked `(NEXT)` but its scope (BYDA-S S0 audit generator, DraftArtifact storage, promote workflow) is fully implemented in the codebase: `/api/audits`, `/api/audits/run`, `/api/draft-artifacts`, `/api/draft-artifacts/[id]/promote`. Update the label to `(DONE)` or `(ACTIVE)` as appropriate.

---

## Layer Results Summary

| Layer | Name | Status | Findings |
|-------|------|--------|----------|
| L0 | System Invariant Compliance | ⚠️ | M1, M3 |
| L1 | Schema-Code Consistency | ✅ | None |
| L2 | API Contract Consistency | ⚠️ | L1 |
| L3 | Documentation Coherence | ⚠️ | L2, L3 |
| L4 | Build & CI Health | ✅ | None |
| L5 | MCP Server Alignment | ✅ | None |
| L6 | Data Model Integrity | ✅ | None |
| L7 | Validation & Error Handling | ⚠️ | M2 |

---

## Recommended Actions

### Platform

1. **M1** — Wrap standalone `ENTITY_VALIDATION_FAILED` EventLog writes in `prisma.$transaction()` in `validate/route.ts` and `request-publish/route.ts`.
2. **M2** — Add try/catch around `request.json()` in `POST /api/entities`, `POST /api/source-items/capture`, and `PUT /api/source-items/[id]/status` to return 400 on malformed JSON.
3. ~~**M3** — Thread `projectId` into `validateEntityForPublish()` and add it to the relationship query where clause.~~ ✅ FIXED 2026-02-22
4. **L1** — Change `successResponse()` to `createdResponse()` in `POST /api/relationships`.
5. **L2** — Update `docs/08-METRIC-TYPE-VOCABULARY.md` to reflect the platform-prefixed MetricType enum convention.
6. **L3** — Update Phase 2 status label in `docs/ROADMAP.md`.

---

## Notes

- Project isolation is structurally sound across all 40+ route handlers. Every route resolves and scopes by projectId. DB-level triggers and composite uniques provide defense-in-depth.
- Transaction atomicity is well-enforced for all mutation+event pairs. The two validation-failure EventLog writes are the only exceptions and carry minimal operational risk.
- The MCP server is tightly aligned with the backend — all 6 tools are read-only, enum values match schema, and UUID validation is consistent.
- The codebase is clean and consistent. The same patterns (UUID_RE, resolveProjectId, parsePagination, deterministic orderBy) are applied uniformly.
- Phase 2 BYDA-S S0 features are well-implemented with proper TTL enforcement, content hash deduplication, and promote-to-metric flow.
- No phase drift detected beyond the implemented Phase 2 scope. No LLM broker, no auto-apply, no background jobs.

---

**Score Calculation:**  
100 − (3 × MEDIUM@5) − (3 × LOW@2) = 100 − 15 − 6 = **79**

**Status:** Yellow (75–89) — system is healthy but attention needed on the 3 MEDIUM findings.
