// PsyMetric Prisma Schema — Multi-Project Scoping
// Derived from: DB-ARCHITECTURE-PLAN.md, 07-RELATIONSHIP-AND-EVENT-VOCABULARY.md
// Project scoping: every domain entity belongs to exactly one Project.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// =============================================================================
// Enums — Canonical vocabularies from docs/07 and DB-ARCHITECTURE-PLAN.md
// =============================================================================

enum SourceType {
  rss
  webpage
  comment
  reply
  video
  other
}

enum Platform {
  website
  x
  youtube
  github
  other
}

enum SourceItemStatus {
  ingested
  triaged
  used
  archived
}

enum CapturedBy {
  human
  llm
  system
}

enum EntityType {
  guide
  concept
  project
  news
  distributionEvent
  video
  sourceItem
  sourceFeed
  metricSnapshot
}

enum ContentEntityType {
  guide
  concept
  project
  news
}

enum EntityStatus {
  draft
  publish_requested
  published
  archived
}

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum ConceptKind {
  standard
  model
  comparison
}

// RelationType — from docs/07-RELATIONSHIP-AND-EVENT-VOCABULARY.md
enum RelationType {
  GUIDE_USES_CONCEPT
  GUIDE_EXPLAINS_CONCEPT
  GUIDE_REFERENCES_SOURCE
  CONCEPT_RELATES_TO_CONCEPT
  CONCEPT_REFERENCES_SOURCE
  NEWS_DERIVED_FROM_SOURCE
  NEWS_REFERENCES_SOURCE
  NEWS_REFERENCES_CONCEPT
  PROJECT_IMPLEMENTS_CONCEPT
  PROJECT_REFERENCES_SOURCE
  PROJECT_HAS_GUIDE
  DISTRIBUTION_PROMOTES_GUIDE
  DISTRIBUTION_PROMOTES_CONCEPT
  DISTRIBUTION_PROMOTES_PROJECT
  DISTRIBUTION_PROMOTES_NEWS
  VIDEO_EXPLAINS_GUIDE
  VIDEO_EXPLAINS_CONCEPT
  VIDEO_EXPLAINS_PROJECT
  VIDEO_EXPLAINS_NEWS
}

// EventType — from docs/07-RELATIONSHIP-AND-EVENT-VOCABULARY.md
enum EventType {
  ENTITY_CREATED
  ENTITY_UPDATED
  ENTITY_PUBLISH_REQUESTED
  ENTITY_PUBLISH_REJECTED
  ENTITY_PUBLISHED
  ENTITY_ARCHIVED
  ENTITY_VALIDATION_FAILED
  SOURCE_CAPTURED
  SOURCE_TRIAGED
  RELATION_CREATED
  RELATION_REMOVED
  DISTRIBUTION_CREATED
  DISTRIBUTION_PLANNED
  DISTRIBUTION_PUBLISHED
  VIDEO_CREATED
  VIDEO_PUBLISHED
  METRIC_SNAPSHOT_RECORDED
  SYSTEM_CONFIG_CHANGED
  DRAFT_CREATED
  DRAFT_EXPIRED
}

enum ActorType {
  human
  llm
  system
}

enum DraftArtifactKind {
  x_reply
}

enum DraftArtifactStatus {
  draft
  archived
}

enum MetricType {
  x_impressions
  x_likes
  x_reposts
  x_replies
  x_bookmarks
}

// =============================================================================
// Project — Multi-project scoping
// Every domain entity belongs to exactly one project.
// =============================================================================

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Reverse relations
  entities           Entity[]
  sourceItems        SourceItem[]
  sourceFeeds        SourceFeed[]
  entityRelations    EntityRelation[]
  eventLogs          EventLog[]
  videos             Video[]
  distributionEvents DistributionEvent[]
  metricSnapshots    MetricSnapshot[]
  draftArtifacts     DraftArtifact[]
}

// =============================================================================
// Source & Capture Entities
// =============================================================================

model SourceItem {
  id             String           @id @default(uuid()) @db.Uuid
  sourceType     SourceType
  platform       Platform         @default(other)
  url            String           @unique
  capturedAt     DateTime         @default(now())
  capturedBy     CapturedBy       @default(human)
  contentHash    String
  snapshotRef    String?
  snapshotMime   String?
  snapshotBytes  Int?
  operatorIntent String
  notes          String?
  status         SourceItemStatus @default(ingested)
  archivedAt     DateTime?

  sourceFeedId   String?          @db.Uuid
  sourceFeed     SourceFeed?      @relation(fields: [sourceFeedId], references: [id], onDelete: SetNull)

  projectId      String           @db.Uuid
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([projectId, status, capturedAt])
  @@index([sourceType, platform])
}

model SourceFeed {
  id            String     @id @default(uuid()) @db.Uuid
  name          String
  feedUrl       String     @unique
  platform      Platform
  platformLabel String?
  isActive      Boolean    @default(true)

  projectId     String     @db.Uuid
  project       Project    @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  sourceItems   SourceItem[]

  @@index([projectId])
}

// =============================================================================
// Content Entities — Unified table for guides, concepts, projects, news
// Using a single table to simplify polymorphic relationships and querying.
// entityType discriminates the kind.
// =============================================================================

model Entity {
  id                String            @id @default(uuid()) @db.Uuid
  entityType        ContentEntityType
  title             String
  slug              String
  summary           String?
  difficulty        Difficulty?
  conceptKind       ConceptKind?      // only for entityType=concept
  comparisonTargets String[]          @db.Uuid @default([]) // only when conceptKind=comparison
  repoUrl           String?           // only for entityType=project
  repoDefaultBranch String?
  license           String?
  status            EntityStatus      @default(draft)
  canonicalUrl      String?
  contentRef        String?
  publishedAt       DateTime?
  archivedAt        DateTime?

  projectId         String            @db.Uuid
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  distributionEvents DistributionEvent[]
  metricSnapshots    MetricSnapshot[]

  @@unique([projectId, entityType, slug])
  @@index([projectId, entityType, status, createdAt])
}

// =============================================================================
// Relationship Graph — from DB-ARCHITECTURE-PLAN.md
// =============================================================================

model EntityRelation {
  id             String       @id @default(uuid()) @db.Uuid
  fromEntityType EntityType
  fromEntityId   String       @db.Uuid
  toEntityType   EntityType
  toEntityId     String       @db.Uuid
  relationType   RelationType
  notes          String?

  projectId      String       @db.Uuid
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt      DateTime     @default(now())

  @@unique([projectId, fromEntityType, fromEntityId, relationType, toEntityType, toEntityId])
  @@index([projectId, fromEntityId])
  @@index([projectId, toEntityId])
}

// =============================================================================
// Event Log — append-only, from DB-ARCHITECTURE-PLAN.md
// projectId added directly to avoid joins for project-scoped audit queries.
// =============================================================================

model EventLog {
  id         String    @id @default(uuid()) @db.Uuid
  eventType  EventType
  entityType EntityType
  entityId   String    @db.Uuid
  actor      ActorType
  details    Json?

  projectId  String    @db.Uuid
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)

  timestamp  DateTime  @default(now())

  @@index([projectId, timestamp, id])
  @@index([entityType, entityId, timestamp])
}

// =============================================================================
// Distribution Entities — Video
// Per DB-ARCHITECTURE-PLAN.md: Video spec
// =============================================================================

model Video {
  id                String            @id @default(uuid()) @db.Uuid
  platform          Platform
  externalUrl       String
  status            EntityStatus      @default(draft)
  publishedAt       DateTime?
  archivedAt        DateTime?
  primaryEntityType ContentEntityType
  primaryEntityId   String            @db.Uuid

  projectId         String            @db.Uuid
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([projectId, primaryEntityType, primaryEntityId])
  @@index([status])
  @@index([platform])
}

// =============================================================================
// Draft Artifacts — scaffolding only, non-canonical
// Per ROADMAP.md Phase 1 Draft System requirements
// =============================================================================

model DraftArtifact {
  id           String              @id @default(uuid()) @db.Uuid
  kind         DraftArtifactKind
  status       DraftArtifactStatus @default(draft)
  content      String
  sourceItemId String?             @db.Uuid
  entityId     String?             @db.Uuid
  createdBy    ActorType
  llmModel     String?
  llmMeta      Json?
  expiresAt    DateTime
  deletedAt    DateTime?

  projectId    String              @db.Uuid
  project      Project             @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([projectId, kind, status])
  @@index([sourceItemId, kind])
  @@index([expiresAt, deletedAt])
}

// =============================================================================
// Distribution Entities — DistributionEvent
// Per PHASE-1-SLICE-DISTRIBUTION-AND-METRICS.md
// =============================================================================

model DistributionEvent {
  id                String            @id @default(uuid()) @db.Uuid
  platform          Platform
  externalUrl       String
  status            EntityStatus      @default(draft)
  publishedAt       DateTime?
  archivedAt        DateTime?
  primaryEntityType ContentEntityType
  primaryEntityId   String            @db.Uuid

  projectId         String            @db.Uuid
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  primaryEntity     Entity?           @relation(fields: [primaryEntityId], references: [id], onDelete: Restrict)

  @@index([projectId, primaryEntityType, primaryEntityId])
  @@index([status])
  @@index([platform])
}

// =============================================================================
// Metrics — MetricSnapshot
// Per PHASE-1-SLICE-DISTRIBUTION-AND-METRICS.md
// =============================================================================

model MetricSnapshot {
  id          String            @id @default(uuid()) @db.Uuid
  metricType  MetricType
  value       Int
  platform    Platform
  capturedAt  DateTime          @default(now())
  entityType  ContentEntityType
  entityId    String            @db.Uuid
  notes       String?

  projectId   String            @db.Uuid
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt   DateTime          @default(now())

  // Relations
  entity      Entity?           @relation(fields: [entityId], references: [id], onDelete: Restrict)

  @@index([projectId, metricType, capturedAt])
  @@index([projectId, entityType, entityId, capturedAt])
}

// =============================================================================
// System Config — from DB-ARCHITECTURE-PLAN.md
// Intentionally NOT project-scoped. Global system configuration.
// =============================================================================

model SystemConfig {
  id        String    @id @default(uuid()) @db.Uuid
  key       String    @unique
  value     Json
  updatedBy ActorType
  updatedAt DateTime  @updatedAt
}
