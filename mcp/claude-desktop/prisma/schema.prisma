// PsyMetric MCP Server Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// Minimal enums needed for MCP server
enum ContentEntityType {
  guide
  concept
  project
  news
}

enum EntityStatus {
  draft
  publish_requested
  published
  archived
}

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum ConceptKind {
  standard
  model
  comparison
}

enum RelationType {
  GUIDE_USES_CONCEPT
  GUIDE_EXPLAINS_CONCEPT
  GUIDE_REFERENCES_SOURCE
  CONCEPT_RELATES_TO_CONCEPT
  CONCEPT_REFERENCES_SOURCE
  NEWS_DERIVED_FROM_SOURCE
  NEWS_REFERENCES_SOURCE
  NEWS_REFERENCES_CONCEPT
  PROJECT_IMPLEMENTS_CONCEPT
  PROJECT_REFERENCES_SOURCE
  PROJECT_HAS_GUIDE
  DISTRIBUTION_PROMOTES_GUIDE
  DISTRIBUTION_PROMOTES_CONCEPT
  DISTRIBUTION_PROMOTES_PROJECT
  DISTRIBUTION_PROMOTES_NEWS
  VIDEO_EXPLAINS_GUIDE
  VIDEO_EXPLAINS_CONCEPT
  VIDEO_EXPLAINS_PROJECT
  VIDEO_EXPLAINS_NEWS
}

enum EntityType {
  guide
  concept
  project
  news
  distributionEvent
  video
  sourceItem
  sourceFeed
  metricSnapshot
}

// Models needed for MCP server
model Project {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entities        Entity[]
  entityRelations EntityRelation[]
}

model Entity {
  id                String            @id @default(uuid()) @db.Uuid
  entityType        ContentEntityType
  title             String
  slug              String
  summary           String?
  difficulty        Difficulty?
  conceptKind       ConceptKind?
  comparisonTargets String[]          @db.Uuid @default([])
  repoUrl           String?
  repoDefaultBranch String?
  license           String?
  status            EntityStatus      @default(draft)
  canonicalUrl      String?
  contentRef        String?
  publishedAt       DateTime?
  archivedAt        DateTime?

  projectId         String            @db.Uuid
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([projectId, entityType, slug])
  @@index([projectId, entityType, status, createdAt])
}

model EntityRelation {
  id             String       @id @default(uuid()) @db.Uuid
  fromEntityType EntityType
  fromEntityId   String       @db.Uuid
  toEntityType   EntityType
  toEntityId     String       @db.Uuid
  relationType   RelationType
  notes          String?

  projectId      String       @db.Uuid
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Restrict)

  createdAt      DateTime     @default(now())

  @@unique([projectId, fromEntityType, fromEntityId, relationType, toEntityType, toEntityId])
  @@index([projectId, fromEntityId])
  @@index([projectId, toEntityId])
}
